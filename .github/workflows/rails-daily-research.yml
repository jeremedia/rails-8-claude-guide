name: Rails Daily Research

on:
  schedule:
    # Run daily at 9:00 AM UTC (adjust for your timezone)
    - cron: '0 9 * * *'
  workflow_dispatch:  # Allow manual triggering
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write  # Required for OIDC token

jobs:
  rails-research:
    runs-on: ubuntu-latest
    name: Daily Rails Update Research
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Get full history for proper git operations

      - name: Configure git
        run: |
          git config --global user.name "Claude Research Bot"
          git config --global user.email "claude-bot@anthropic.com"

      - name: Pull latest changes
        run: |
          git pull origin main || echo "No remote changes to pull"

      - name: Set run metadata
        id: metadata
        run: |
          echo "start_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          echo "date=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "trigger=${{ github.event_name }}" >> $GITHUB_OUTPUT
          echo "run_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT

      - name: Run Rails Research with Claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            You are maintaining the Rails 8 knowledge base repository. Perform the following daily research tasks:

            1. Check these primary sources for Rails news:
               - Rails Blog (https://rubyonrails.org/blog)
               - Rails GitHub Releases (https://github.com/rails/rails/releases)
               - Rails Edge Guides (https://edgeguides.rubyonrails.org/)
               - 37signals Dev Blog (https://dev.37signals.com/)
               - Recent Rails commits (https://github.com/rails/rails/commits/main)

            2. Look specifically for:
               - New Rails 8.x releases, patches, or security updates
               - Rails 8.1 beta updates and release candidates
               - Breaking changes or deprecations
               - New features or significant improvements
               - Performance optimizations
               - Production insights from companies using Rails 8
               - Updates to the Solid trilogy (Queue/Cache/Cable)
               - Active Storage or Turbo/Stimulus updates

            3. CRITICAL: Create a file named "daily_report.md" in the repository root with your findings using this EXACT format:
               
               ## üìÖ Rails Daily Research Report - ${{ steps.metadata.outputs.date }}
               
               ### ü§ñ Automation Metadata
               - **Run ID**: ${{ github.run_id }}
               - **Run Number**: #${{ github.run_number }}
               - **Triggered**: ${{ steps.metadata.outputs.trigger }} at ${{ steps.metadata.outputs.start_time }}
               - **Workflow**: [View Run](${{ steps.metadata.outputs.run_url }})
               - **Status**: ‚úÖ Automated research completed
               - **Next Scheduled Run**: Tomorrow at 09:00 UTC
               
               ### üîç Sources Checked
               - [ ] Rails Blog (https://rubyonrails.org/blog)
               - [ ] GitHub Releases (https://github.com/rails/rails/releases)
               - [ ] Rails Edge Guides (https://edgeguides.rubyonrails.org/)
               - [ ] 37signals Dev Blog (https://dev.37signals.com/)
               - [ ] Recent commits (https://github.com/rails/rails/commits/main)
               
               Mark with [x] for sources you successfully checked.
               
               ### üì∞ Findings
               
               [ONE OF THE FOLLOWING:]
               
               [IF UPDATES FOUND:]
               For each finding:
               - **Title**: [Title with link]
               - **Impact**: üî¥ Critical / üü° Important / üü¢ Informational
               - **Summary**: Brief description
               - **Action**: Documentation updated / Monitoring / No action needed
               
               [IF NO UPDATES FOUND:]
               ‚úÖ **No new Rails updates found today**
               
               All sources checked successfully. No new releases, security updates, or significant changes detected since the last scan.
               
               ### üìä Daily Statistics
               - Rails versions checked: 8.0.x, 8.1.beta1
               - New findings: [number]
               - Documentation updates: [number of files changed or "None"]
               - Research duration: ~2-3 minutes
               
               ### üîÑ Repository Status
               - Research: ‚úÖ Complete
               - Documentation: [‚úÖ Updated / ‚úÖ No updates needed]
               - Report: Generated at ${{ steps.metadata.outputs.start_time }}
               
               ---
               *Automated by [Rails Daily Research Workflow](https://github.com/${{ github.repository }}/blob/main/.github/workflows/rails-daily-research.yml)*

            4. If you find significant updates that affect the documentation:
               - Update the relevant .md files in the repository
               - Create new documentation files if needed for major features
               - Update the README.md with any critical information
               - List the files changed in your report

            5. After creating the daily_report.md file:
               - Ensure it's saved in the repository root
               - Do NOT post to GitHub issues directly
               - The workflow will handle posting the report

            IMPORTANT: You MUST create the daily_report.md file even if no updates are found. This file will be posted to issue #2 by the workflow.
          claude_args: |
            --max-turns 15
            --model claude-sonnet-4-20250514
            --allowedTools WebSearch,WebFetch,Read,Write,Edit,MultiEdit,Bash

      - name: Check for changes
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in repository"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          fi

      - name: Commit changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git add -A
          git commit -m "Automated Rails research update - $(date +'%Y-%m-%d')

          Daily Rails research performed by GitHub Action using Claude Code.
          See issue #2 for detailed findings.

          ü§ñ Automated with Claude Code GitHub Action" || echo "No changes to commit"

      - name: Push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git push origin main || echo "Failed to push changes"

      - name: Post daily report to issue
        id: post_report
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if daily report file exists
          if [ -f "daily_report.md" ]; then
            echo "‚úÖ Daily report file found"
            
            # Post the report content to issue #2
            REPORT_CONTENT=$(cat daily_report.md)
            
            # Use GitHub CLI to create comment
            gh issue comment 2 --body "$REPORT_CONTENT"
            
            echo "‚úÖ Report posted to issue #2"
            echo "report_posted=true" >> $GITHUB_OUTPUT
            
            # Remove the report file to keep repo clean
            rm daily_report.md
            echo "üßπ Cleaned up daily_report.md"
          else
            echo "‚ö†Ô∏è No daily report file found"
            echo "report_posted=false" >> $GITHUB_OUTPUT
            
            # Create a minimal report if Claude didn't create one
            cat > fallback_report.md << EOF
          ## üìÖ Rails Daily Research Report - ${{ steps.metadata.outputs.date }}
          
          ### ü§ñ Automation Metadata
          - **Run ID**: ${{ github.run_id }}
          - **Run Number**: #${{ github.run_number }}
          - **Triggered**: ${{ steps.metadata.outputs.trigger }} at ${{ steps.metadata.outputs.start_time }}
          - **Workflow**: [View Run](${{ steps.metadata.outputs.run_url }})
          
          ### ‚ö†Ô∏è Report Generation Issue
          
          The automated research completed but no report file was generated.
          This typically means Claude encountered an issue during research.
          
          Please check the [workflow logs](${{ steps.metadata.outputs.run_url }}) for details.
          
          ### üîÑ Status
          - Research: ‚ö†Ô∏è Completed with issues
          - Next run: Scheduled for tomorrow at 09:00 UTC
          
          ---
          *Automated fallback from [Rails Daily Research Workflow](https://github.com/${{ github.repository }}/blob/main/.github/workflows/rails-daily-research.yml)*
          EOF
            
            # Post the fallback report
            gh issue comment 2 --body-file fallback_report.md
            echo "‚ö†Ô∏è Posted fallback report to issue #2"
            rm fallback_report.md
          fi

      - name: Summary
        run: |
          END_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          START_TIME="${{ steps.metadata.outputs.start_time }}"
          
          # Calculate duration (rough estimate)
          DURATION_SECONDS=$(($(date -d "$END_TIME" +%s) - $(date -d "$START_TIME" +%s)))
          DURATION_MINUTES=$((DURATION_SECONDS / 60))
          DURATION_REMAINING=$((DURATION_SECONDS % 60))
          
          echo "## üìä Rails Research Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: ${{ steps.metadata.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration**: ${DURATION_MINUTES}m ${DURATION_REMAINING}s" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ‚úÖ Research completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Report Posted**: $([[ "${{ steps.post_report.outputs.report_posted }}" == "true" ]] && echo "‚úÖ Yes" || echo "‚ö†Ô∏è Fallback used")" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes**: $([[ "${{ steps.check_changes.outputs.changes }}" == "true" ]] && echo "üìù Documentation updated" || echo "No updates needed")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed findings in [Issue #2](https://github.com/${{ github.repository }}/issues/2)" >> $GITHUB_STEP_SUMMARY

      - name: Error notification
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: 2,
              body: `## ‚ùå Rails Research Failed - ${new Date().toISOString().split('T')[0]}
              
              The automated Rails research encountered an error.
              
              [View workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              Please check the logs and run manually if needed.`
            })